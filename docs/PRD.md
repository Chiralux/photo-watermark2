# Photo Watermark 桌面应用 PRD

> 版本：v1.1  
> 项目代号：photo-watermark2  
> 平台：Windows 10+/macOS 12+（Apple Silicon/Intel）  
> 更新时间：2025-09-27

## 1. 背景与目标

- 背景：个人/工作场景中，批量为图片添加文本或图像水印的需求频繁且重复，现有工具要么过重、要么体验繁琐。
- 产品目标：提供一个轻量、直观、跨平台的本地水印工具，满足单张/批量图片快速添加文字或图片水印，并支持模板化复用。
- 成功标准（可量化）：
  - 首次使用到导出完成的上手时长 ≤ 3 分钟。
  - 批量 100 张图片（1920x1080）在常规笔记本上导出时间 ≤ 60 秒（纯文本水印）。
  - 关键流程（导入-配置-预览-导出）用户完成率 ≥ 95%。

## 2. 术语与范围

- 术语：
  - 输入图片：用户导入的原始图片文件。
  - 水印：覆盖在输入图片之上的文本或图像元素。
  - 模板：一组水印配置参数的集合，可保存/加载。
- 范围：
  - In Scope：本地图片导入、预览、水印配置、批量导出、模板管理。
  - Out of Scope：在线存储/云同步、视频水印、矢量编辑、团队协作、移动端。

## 3. 用户画像与核心场景

- 用户画像：自媒体作者、电商运营、设计/市场人员、讲师/培训机构、法务/档案管理人员。
- 典型使用场景：
  1) 一次性为若干产品图添加品牌文案水印并批量导出。
  2) 按平台规范调整水印位置与透明度，导出 PNG 用于保持透明背景。
  3) 保存“品牌默认水印模板”，下次打开直接复用并批量处理新图片。

## 4. 功能需求

### 4.1 文件处理

- 导入图片
  - 支持单张图片拖拽或通过文件选择器导入。
  - 支持批量导入：一次性多选或选择文件夹（递归读取常见图片格式）。
  - 导入行为：追加到现有列表、对重复文件（路径）自动去重，并自动选中新导入项进行预览。
  - 在界面显示已导入图片列表（缩略图+文件名；提供小图快速浏览）。
- 支持格式
  - 输入：必须支持 JPEG、PNG；强烈建议支持 BMP、TIFF；PNG 必须支持透明通道。
  - 输出：用户可选择 JPEG 或 PNG。
- 导出图片
  - 用户可指定输出文件夹；默认禁止导出到与原图相同的文件夹（可被显式解除，需二次确认）。
  - 文件命名规则：保留原名/自定义前缀/自定义后缀，可组合使用；示例：`wm_原名_suffix`（默认前缀为 `wm_`）。
  - 输出文件名唯一性：导出批量图片时自动避免重名覆盖（生成唯一文件名）。
  - 导出范围：支持“仅当前预览”与“列表全部”，默认“仅当前”，并持久化用户选择。
  - JPEG 质量滑块 0–100（可选高级）。
  - 导出时可按宽度/高度/百分比缩放（可选高级）。

### 4.2 水印类型

- 文本水印（必选）
  - 内容：任意文本输入，支持换行。
  - 快速填充：一键“使用拍摄时间（EXIF）”将当前图片的拍摄时间写入文本内容。
  - 字体：可选择系统已安装的字体、字号、粗体、斜体（可选高级）。
  - 颜色：调色板选择，支持不透明度/Alpha（可选高级）。
  - 透明度：0–100%。
  - 样式：阴影/描边（可选高级）。
- 图片水印（可选高级）
  - 选择本地图片（Logo 等）作为水印；必须支持透明 PNG。
  - 缩放：按比例或自由调整大小。
  - 透明度：0–100%。

### 4.3 布局与样式

- 实时预览：对水印的任何调整在主预览窗口即时生效；可在图片列表切换预览目标。
- 位置：
  - 预设九宫格：左上/上中/右上/左中/正中/右中/左下/下中/右下。
  - 手动拖拽：在预览图中通过鼠标拖拽水印到任意位置；支持吸附到边距与标尺（可选高级）。
- 旋转：滑块或输入框任意角度（可选高级）。
 - 预览/导出一致性：统一缩放与锚点算法，确保九宫格与拖拽位置在导出结果与预览一致。
 - 基线微调（导出专用）：提供“导出仅影响”的基线细调参数，用于兼容字体基线差异，不影响预览布局。
   - 适用范围：仅影响“文本水印”的导出结果；不影响预览画面与“图片水印”。
   - 单位与范围：以像素为单位的整数，默认 0；建议范围 [-10, 10]（范围可配置）。
   - 生效时机：仅在导出阶段应用到文本排版基线，预览阶段不应用。
   - 持久化：参数可保存到模板中，加载模板后自动复用。

### 4.4 配置管理

- 水印模板
  - 保存当前所有水印参数（水印内容、字体、颜色、位置、大小、透明度等）为模板（名称唯一）。
  - 加载/覆盖/删除模板。
  - 启动自动加载：支持“上次使用”或“默认模板”两种模式；仅在“默认模板”模式下显示模板选择器。
  - 模板列表隐藏保留项：如内部配置 `_config.json` 不在模板列表中展示，且删除时有保护。
  - 模板内容应包含“导出专用基线微调”参数，以便导出时复用偏移设置。

### 4.5 元数据（EXIF）与回退

- 拍摄时间读取
  - 优先从 EXIF/XMP/GPS 标签读取拍摄时间（如 DateTimeOriginal、CreateDate、GPSDateStamp+GPSTimeStamp 等）。
  - 当 EXIF 缺失或不可解析时，提供两种可选回退策略（可在设置中开关）：
    1) 从文件名解析日期（常见命名模式）；
    2) 使用文件修改时间。
  - UI 显示“拍摄时间来源”（EXIF/XMP/GPS/文件名/文件时间），便于用户确认。

## 5. 非功能需求

- 跨平台：Windows 10+ 与 macOS 12+ 原生或跨平台框架实现；UI 操作一致性优先。
- 性能：
  - 生成缩略图应异步并缓存，避免卡顿；
  - 批量导出应使用任务队列并并发（可配置并发度）。
- 可靠性：
  - 对不可读/损坏文件给予明确错误提示并跳过；
  - 导出失败提供重试与失败清单导出（CSV）。
- 本地化：首版中文 UI，预留国际化机制。
- 隐私与安全：全程本地处理，不上传任何图片；遵守系统沙盒/权限。
- 可扩展性：模块化架构，方便后续增加滤镜、EXIF 读写等。

## 6. 交互与信息架构（IA）

- 顶部：菜单/工具栏（导入、导出、模板、设置）。
- 左侧：图片列表（缩略图+文件名，支持多选、删除、重新排序）。
- 中央：预览画布（等比缩放、网格/标尺开关、拖拽放置水印）。
- 右侧：属性面板
  - 水印类型（文本/图片切换）
  - 文本属性（内容、字体、大小、颜色、透明度、阴影/描边）
  - 图片属性（选择文件、缩放、透明度）
  - 布局（九宫格、X/Y 偏移、旋转）
  - 导出（格式、命名、质量、尺寸）
- 状态栏：当前选择、缩放比例、进度反馈（导出）。

### 6.1 关键流程

1) 导入流程：拖拽/选择 -> 解析 -> 生成缩略图 -> 列表展示 -> 自动选择第一张预览。
2) 配置水印：切换文本/图片 -> 设置内容/样式 -> 拖拽定位或九宫格定位 -> 预览确认。
3) 批量导出：选择输出目录 -> 校验不等于源目录 -> 设置格式与命名 -> 开始 -> 进度条/队列 -> 完成弹窗。
4) 快速填充拍摄时间：选择图片 -> （若已解析）点击“使用拍摄时间”按钮 -> 文本水印内容自动填充 -> 预览确认。

### 6.2 空状态与异常

- 未导入图片：显示引导（拖拽或点击导入）。
- 不支持的格式：弹出说明并跳过；在列表中标记为失败。
- 导出目录与源目录相同：二次确认开关（默认阻止）。
 - 无法解析拍摄时间：按钮置灰并在拍摄时间位置显示“未读取”；若开启回退策略，展示来源并允许一键填充。
 - 导出结果与预览存在像素级细小偏移：提示用户使用“导出专用基线微调”进行微调（仅影响导出），并建议将调整值保存为模板以便后续复用。

## 7. 数据与配置模型

- 模板结构（示例，JSON）：
```json
{
  "name": "品牌默认文本水印",
  "type": "text", // text | image
  "text": {
    "content": "© MyBrand",
    "fontFamily": "PingFang SC",
    "fontSize": 32,
    "bold": false,
    "italic": false,
    "color": "#FFFFFF",
    "opacity": 0.6,
    "shadow": { "enabled": true, "blur": 4, "offsetX": 1, "offsetY": 1, "color": "#00000080" },
    "stroke": { "enabled": false, "width": 1, "color": "#00000080" }
  },
  "image": {
    "path": "",
    "scale": 1.0,
    "opacity": 0.6
  },
  "layout": {
    "preset": "center", // tl, tc, tr, cl, center, cr, bl, bc, br
    "offsetX": 0,
    "offsetY": 0,
    "rotation": 0
  },
  "export": {
    "format": "png", // png | jpeg
    "jpegQuality": 90,
    "naming": { "mode": "suffix", "prefix": "wm_", "suffix": "_watermarked", "ensureUnique": true },
    "resize": { "mode": "none", "width": 0, "height": 0, "scalePercent": 100 },
    "baselineAdjust": 0 // 仅在导出阶段对文本水印的基线进行像素级微调；单位像素，整数，默认 0
  },
  "lastModified": "2025-09-26T10:00:00Z",
  "version": 1
}
```

> 说明：`export.baselineAdjust` 仅在导出阶段生效，用于文本水印的基线像素级微调；不会影响预览布局与图片水印。

### 7.1 元数据回退配置（示例，JSON）

```json
{
  "metaFallback": {
    "allowFilename": true,
    "allowFileTime": false
  }
}
```

## 8. 技术方案建议（非约束）

- 技术栈选型：
  - 跨平台 UI：Electron + React/Vite 或 Tauri + React/Svelte；或 .NET MAUI；或 Qt。
  - 图像处理：
    - 跨平台 Node: sharp/jimp；
    - Rust（Tauri）：image、raqote、resvg；
    - .NET：SkiaSharp/ImageSharp；
    - 原生：CoreGraphics（macOS）/GDI+/Direct2D（Windows）。
  - 字体/文本排版：Canvas/Skia；支持文字阴影/描边。
  - 配置与模板：JSON 文件存储（用户配置目录），最近使用记录。
- 并发导出：
  - 任务队列 + 工作线程池；限制并发数（默认 CPU 核心数）。
- 透明度/合成：遵循预乘 Alpha；PNG 透明度支持。

## 9. 边界与兼容

- 最大导入文件：单张 ≤ 100MB；批量 ≤ 1000 张（可在设置中调整上限）。
- 颜色空间：默认 sRGB；忽略复杂 ICC Profile 的色彩管理差异（后续优化）。
- DPI/EXIF：不修改除非用户选择“保留原始元数据”（后续扩展）。

## 10. 路线图与里程碑

- M1（核心可用）：导入/预览/文本水印/九宫格/拖拽/导出 JPEG/PNG/命名规则/模板保存加载（3–4 周）。
- M2（增强）：图片水印/旋转/字体选择/颜色选择/阴影描边/JPEG 质量/导出尺寸调整（2–3 周）。
- M3（体验/性能）：并发导出、失败重试、国际化、快捷键、最近项目（2–3 周）。

（v1.1 已完成变更要点）
- 文本水印“使用拍摄时间”按钮与来源显示；
- EXIF/XMP/GPS 优先解析，提供文件名/文件时间回退开关；
- 导出范围（仅当前/全部，默认仅当前）并持久化；
- 导入追加与去重、自动选中新导入；
- 模板自动加载模式与隐藏保留模板；
- 输出唯一命名避免覆盖；
- 预览/导出一致性与导出专用基线微调。
 - 模板包含导出专用基线微调参数，并在导出阶段按模板自动应用。

## 11. 验收标准（UAT）

- 文件处理：
  - 能拖拽/选择多张图片或文件夹；不支持格式被正确跳过并提示。
  - 列表显示缩略图与文件名；点击切换预览无明显卡顿（<100ms UI 响应）。
- 文本水印：
  - 任意文本即时预览；透明度调节生效；九宫格/拖拽准确定位；
  - 当已解析拍摄时间时，“使用拍摄时间”可点击，点击后文本内容被正确填充；显示来源为 EXIF/XMP/GPS/文件名/文件时间之一。
- 图片水印：
  - 选择透明 PNG 作为水印，缩放与透明度生效，叠加正确。
- 导出：
  - 输出目录校验；命名规则生效（默认前缀 wm_、且确保唯一不覆盖）；JPEG/PNG 导出正确；导出范围选择默认“仅当前”且可持久化；可选功能在设置开启后可用。
 - 基线微调（导出专用）：
   - 设置 `baselineAdjust` 后，导出结果中文本水印相对于预览产生对应像素位移，且预览布局保持不变；
   - 将该参数保存到模板，重新加载模板并导出时仍按该偏移应用。
- 模板：
  - 能保存/覆盖/删除；应用后所有参数还原；支持“上次使用/默认模板”自动加载；内部保留模板不显示且删除受保护。

## 12. 监控与度量（离线）

- 本地记录（可选）：
  - 最近打开的目录/模板；
  - 导出用时统计与失败原因（本地日志，不含图片/隐私数据）。

## 13. 风险与缓解

- 大图/批量导出导致内存压力：采用流式与任务队列、按需释放资源。
- 字体跨平台差异：提供回退字体与自带开源字体选项。
- 不同图像库在 alpha 合成与色彩管理差异：统一渲染管线并进行对照测试。

## 14. 开放问题

- 是否需要水印平铺（tiled watermark）模式？
- 是否需要命令行（CLI）批处理入口？
- 是否需要导出时写入/保留 EXIF？

---

附录 A：九宫格定位规则（相对定位）
- tl（左上）：(margin, margin)
- tc（上中）：(W/2, margin)
- tr（右上）：(W - margin, margin)
- cl（左中）：(margin, H/2)
- center（正中）：(W/2, H/2)
- cr（右中）：(W - margin, H/2)
- bl（左下）：(margin, H - margin)
- bc（下中）：(W/2, H - margin)
- br（右下）：(W - margin, H - margin)

附录 B：命名规则组合
- 保留原名：`原名.ext`
- 前缀：`wm_原名.ext`
- 后缀：`原名_watermarked.ext`
- 组合：`wm_原名_watermarked.ext`
