\n# Photo Watermark 桌面应用

轻量、直观、跨平台的本地图片水印工具。支持为单张或批量图片添加文本/图片水印，提供实时预览、九宫格/拖拽定位、模板管理与安全的本地导出流程。

文档：参见 [产品需求文档（PRD）](docs/PRD.md)

## 主要特性

- 本地离线处理：不上传任何图片，隐私友好。
- 批量导入与导出：支持多选/文件夹导入，导出 JPEG/PNG（自动避免重名覆盖）。
- 文本水印：任意文本、换行、透明度、字体（系统字体）、大小等；一键使用拍摄时间（EXIF）。
- 图片水印（可选）：支持透明 PNG 作为 Logo 水印，缩放与透明度调节。
- 位置与布局：九宫格预设与画布拖拽定位；预览/导出位置一致性校准。
- 模板管理：保存/加载/删除模板，支持“上次使用/默认模板”自动加载。
- 导出控制：命名前后缀、JPEG 质量、导出范围（仅当前/全部，默认仅当前）。

> 注：部分“可选/高级”能力可能处于迭代中，请以实际版本为准。

## 系统要求

- 操作系统：
	- Windows 10 及以上
	- macOS 12 及以上（Apple Silicon/Intel）
- Node.js（开发者从源码运行）：建议 >= 18（推荐 LTS 20）

## 安装与下载

- Windows 便捷安装：下载 `release/` 目录中的最新版安装包（示例：`Photo-Watermark-0.1.2-win-x64.exe`）并运行安装。
- 便携/免安装：可使用 `release/Photo-Watermark-0.1.2-win-x64.zip` 或 `win-unpacked/` 目录中的可执行文件。
- macOS 安装包：后续版本提供。

也可在 GitHub Releases 页面下载最新版本（如适用）。

## 从源码运行（开发模式）

1) 安装依赖

```bash
npm install
```

2) 启动开发（Vite + Electron）

```bash
npm run dev
```

- 默认使用端口 5173；如被占用，可使用：`npm run dev:5174`。
- 仅调试前端：`npm run dev:vite`；仅调试 Electron：`npm run dev:electron`。

3) 直接启动 Electron（非热更新）

```bash
npm start
```

## 构建与打包

- 构建渲染进程并打包应用：

```bash
npm run build
```

- 打包配置见 `electron-builder.yml`，产物默认输出到 `release/` 目录。
- 仅构建前端（不打包）：`npm run build:renderer`

## 使用说明（快速上手）

1) 导入图片：拖拽到窗口或点击选择文件/文件夹；自动去重并选中第一张预览。
2) 选择水印类型：文本（默认）或图片（Logo）。
3) 文本水印：输入/粘贴文本，选择字体/大小/透明度；如可用，点击“使用拍摄时间（EXIF）”一键填充。
4) 定位：选择九宫格预设或直接在预览画布拖拽到任意位置；可微调偏移与旋转（如可用）。
5) 导出设置：
	 - 格式：PNG/JPEG；JPEG 可设置质量。
	 - 命名：前缀/后缀（默认前缀 `wm_`），自动确保文件名唯一。
	 - 范围：仅当前/全部（默认仅当前，记忆上次选择）。
6) 导出：选择输出目录（默认阻止导出到源目录，可手动解除并二次确认）。

## 模板与配置

- 模板保存：将当前的水印内容、样式、位置、导出参数等保存为模板。
- 模板管理：支持加载/覆盖/删除；内部保留模板不在列表展示并受保护。
- 自动加载：可在“上次使用”与“默认模板”两种模式间切换。

## EXIF/元数据

- 拍摄时间优先从 EXIF/XMP/GPS 提取；若缺失，可开启回退：
	1) 从文件名解析（常见命名模式）；
	2) 使用文件修改时间。
- UI 会显示“拍摄时间来源”（EXIF/XMP/GPS/文件名/文件时间），便于确认。

## 目录结构（节选）

```
electron/          # 主进程与 IPC 模块（导出、预览、系统字体、EXIF 等）
src/               # 渲染进程（React + Vite）
	components/      # 预览、字体选择、大小估算等组件
	hooks/           # 预览几何计算等
	utils/           # 颜色/字体/数学/锚点等工具
docs/PRD.md        # 产品需求文档
release/           # 打包产物（exe/zip/win-unpacked 等）
```

## 常见问题（FAQ）

- 为什么“使用拍摄时间”是灰色的？
	- 说明当前图片尚未解析到可用时间；可开启回退策略（从文件名或文件时间）。
- 能导出到原图目录吗？
	- 默认阻止以避免覆盖，可显式解除并有二次确认提示。
- 图片水印支持哪些格式？
	- 推荐使用带透明通道的 PNG；其他格式兼容性以实际版本为准。
- 大量图片导出会卡吗？
	- 导出采用任务队列与并发控制，通常在常规笔记本上也能流畅完成。

- 导出结果的水印位置与预览有细小偏移？
	- 个别字体的基线/渲染差异或缩放取整可能导致像素级偏移。可在“导出专用基线微调”中微调（仅影响导出，不改变预览布局），建议将该值保存到模板以便复用。

## 技术栈与脚本

- Electron + React + Vite
- 图像处理：`sharp`
- 画布/交互：`konva` / `react-konva`
- 队列并发：`p-queue`
- 元数据读取：`exifr`/`exif-reader` 等

常用 npm 脚本：

- `npm run dev`：开发模式（Vite + Electron 热更新）
- `npm run dev:vite`：仅前端
- `npm run dev:electron`：仅 Electron 主进程
- `npm run build`：构建并打包
- `npm run build:renderer`：仅构建前端

## 路线图（Roadmap）

- M1（核心可用）：导入/预览/文本水印/九宫格/拖拽/导出 JPEG/PNG/命名规则/模板保存加载。
- M2（增强）：图片水印/旋转/字体选择/颜色选择/阴影描边/JPEG 质量/导出尺寸调整。
- M3（体验/性能）：并发导出、失败重试、国际化、快捷键、最近项目。

详细见 [PRD](docs/PRD.md)。

## 隐私与安全

应用在本地设备上完成所有处理，不上传任何图片与个人数据。

## 许可证

MIT License（见 [LICENSE](LICENSE)）。
